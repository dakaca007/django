<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级音频播放器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .audio-player {
            max-width: 400px;
            margin: 2rem auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .now-playing {
            text-align: center;
            margin-bottom: 15px;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        .controls button {
            background: #00bcd4;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }
        .controls button:hover {
            background: #0097a7;
        }
        .controls button.active {
            background: #03a9f4;
        }
        .mode-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #00bcd4;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .mode-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .player-playing {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="audio-player" id="audioPlayer">
        <div class="now-playing">
            <h3 id="nowPlaying">选择一首歌</h3>
            <p id="songArtist"></p>
        </div>
        <div class="controls">
            <button id="shuffle"><i class="fas fa-random"></i></button>
            <button id="prev"><i class="fas fa-step-backward"></i></button>
            <button id="playPause"><i class="fas fa-play"></i></button>
            <button id="next"><i class="fas fa-step-forward"></i></button>
            <button id="repeat"><i class="fas fa-redo"></i></button>
        </div>
    </div>

    <div class="mode-toast" id="modeToast"></div>

    <audio id="audio"></audio>

    <script>
        const audio = document.getElementById('audio');
        const playPauseBtn = document.getElementById('playPause');
        const nextBtn = document.getElementById('next');
        const prevBtn = document.getElementById('prev');
        const shuffleBtn = document.getElementById('shuffle');
        const repeatBtn = document.getElementById('repeat');
        const nowPlaying = document.getElementById('nowPlaying');
        const songArtist = document.getElementById('songArtist');
        const modeToast = document.getElementById('modeToast');

        // 示例歌曲数据
        const songs = [
            { song_id: 1, title: "夏日狂欢曲", artist: "晴天乐队", album: "夏日物语" },
            { song_id: 2, title: "夜空中最亮的星", artist: "星空乐队", album: "宇宙之歌" },
            { song_id: 3, title: "雨季不再来", artist: "雨滴组合", album: "四季之歌" }
        ];

        let currentSongIndex = 0;
        let isPlaying = false;
        let currentSongId = null;
        let playMode = 'list'; // list, single, shuffle
        let shuffleQueue = [];

        // 播放模式图标映射
        const modeIcons = {
            'list': '<i class="fas fa-redo"></i>',
            'single': '<i class="fas fa-dot-circle"></i>',
            'shuffle': '<i class="fas fa-random"></i>'
        };

        // 初始化
        function init() {
            setupEventListeners();
            setupShuffleQueue();
            updatePlayModeUI();
            updatePlayButtonState();
        }

        // 设置事件监听器
        function setupEventListeners() {
            playPauseBtn.addEventListener('click', togglePlay);
            nextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);
            shuffleBtn.addEventListener('click', () => setPlayMode('shuffle'));
            repeatBtn.addEventListener('click', () => {
                const modes = ['list', 'single', 'list'];
                setPlayMode(modes[getModeIndex()]);
            });
            audio.addEventListener('ended', handleSongEnd);
        }

        // 获取当前播放模式索引
        function getModeIndex() {
            const modes = ['list', 'single', 'shuffle'];
            return (modes.indexOf(playMode) + 1) % modes.length;
        }

        // 设置播放模式
        function setPlayMode(mode) {
            playMode = mode;
            updatePlayModeUI();
            showModeToast();
            
            if (mode === 'shuffle') {
                generateShuffleQueue();
            }
        }

        // 生成随机播放队列
        function generateShuffleQueue() {
            const indexes = [...Array(songs.length).keys()].filter(i => i !== currentSongIndex);
            shuffleQueue = shuffleArray([...indexes]);
        }

        // 随机洗牌算法（Fisher-Yates）
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 播放指定歌曲
        async function playSong(index) {
            if (index < 0 || index >= songs.length) return;
            
            stopCurrentPlayback();
            currentSongIndex = index;
            const song = songs[index];
            currentSongId = song.song_id;
            
            // 更新UI
            nowPlaying.textContent = song.title;
            songArtist.textContent = song.artist;
            document.getElementById('audioPlayer').style.animation = 'pulse 2s infinite';
            
            // 设置音频源
            audio.src = `/play/${song.song_id}`;
            
            // 加载歌词（示例）
            try {
                const res = await fetch(`/lyric/${song.song_id}`);
                const text = await res.text();
                // 处理歌词（示例）
                // parseLyrics(text);
            } catch (error) {
                console.error('获取歌词失败:', error);
            }
            
            // 尝试自动播放
            try {
                await audio.play();
                isPlaying = true;
                updatePlayButtonState();
                document.getElementById('audioPlayer').classList.add('player-playing');
            } catch (err) {
                console.error('自动播放失败:', err);
                isPlaying = false;
                updatePlayButtonState();
            }
        }

        // 停止当前播放
        function stopCurrentPlayback() {
            if (audio.currentTime > 0 && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
            document.getElementById('audioPlayer').style.animation = 'none';
            isPlaying = false;
            updatePlayButtonState();
        }

        // 切换播放/暂停
        function togglePlay() {
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play().catch(err => {
                    console.error('播放失败:', err);
                    isPlaying = false;
                    updatePlayButtonState();
                });
            }
            isPlaying = !isPlaying;
            updatePlayButtonState();
        }

        // 播放下一曲
        function playNext() {
            let nextIndex;
            
            if (playMode === 'shuffle') {
                if (shuffleQueue.length === 0) generateShuffleQueue();
                nextIndex = shuffleQueue.pop();
            } else if (playMode === 'single') {
                nextIndex = currentSongIndex;
            } else {
                nextIndex = (currentSongIndex + 1) % songs.length;
            }
            
            playSong(nextIndex);
        }

        // 播放上一曲
        function playPrev() {
            const prevIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            playSong(prevIndex);
        }

        // 处理歌曲结束
        function handleSongEnd() {
            playNext();
        }

        // 更新播放按钮状态
        function updatePlayButtonState() {
            playPauseBtn.innerHTML = isPlaying 
                ? '<i class="fas fa-pause"></i>' 
                : '<i class="fas fa-play"></i>';
        }

        // 更新播放模式UI
        function updatePlayModeUI() {
            shuffleBtn.classList.toggle('active', playMode === 'shuffle');
            repeatBtn.classList.toggle('active', playMode === 'single');
            repeatBtn.innerHTML = modeIcons[playMode];
        }

        // 显示模式切换提示
        function showModeToast() {
            modeToast.textContent = {
                'list': '顺序播放',
                'single': '单曲循环',
                'shuffle': '随机播放'
            }[playMode];
            
            modeToast.classList.add('show');
            setTimeout(() => modeToast.classList.remove('show'), 2000);
        }

        // 初始化播放器
        init();

        // 初始播放第一首歌
        playSong(0);
    </script>
</body>
</html>