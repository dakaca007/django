<!DOCTYPE html>
<html>
<head>
    <title>Online Code Editor</title>
    <!-- Ace Editor CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <!-- Socket.IO CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
</head>
<body>
    <div id="editor" style="height: 70vh; width: 80%; margin: 20px auto;"></div>
    <button onclick="execute()" style="margin-left: 10%">运行代码</button>
    <div id="output" style="white-space: pre-wrap; margin: 20px 10%"></div>

    <script>
        // 初始化编辑器
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");
        
        // 初始化WebSocket连接
        const socket = io();
        
        // 实时协作处理
        let isRemoteUpdate = false;
        editor.on('change', (delta) => {
            if (!isRemoteUpdate) {
                socket.emit('code_update', {
                    delta: delta,
                    code: editor.getValue()
                });
            }
        });

        socket.on('code_update', (data) => {
            isRemoteUpdate = true;
            editor.getSession().applyDeltas([data.delta]);
            isRemoteUpdate = false;
        });

        // 执行代码
        async function execute() {
            const code = editor.getValue();
            const outputDiv = document.getElementById('output');
            
            outputDiv.innerHTML = "执行中...";
            
            try {
                const response = await fetch('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                
                const result = await response.json();
                outputDiv.innerHTML = `
                    ${result.output ? "输出:\n" + result.output : ""}
                    ${result.error ? "错误:\n" + result.error : ""}
                `;
            } catch (err) {
                outputDiv.innerHTML = "请求失败: " + err.message;
            }
        }
    </script>
</body>
</html>
